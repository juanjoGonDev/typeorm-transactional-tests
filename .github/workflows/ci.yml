name: 🧪 CI

permissions:
  contents: read

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, ready_for_review, synchronize]

env:
  NODE_VERSION: ${{vars.NODE_VERSION}}
  PNPM_VERSION: ${{vars.PNPM_VERSION}}

concurrency:
  group: ${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  build:
    if: github.event.pull_request.head.repo.full_name == github.repository
    name: 📦 Build
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v5
      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "${{ env.PNPM_VERSION }}"
          run_install: false
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "${{ env.NODE_VERSION }}"
          cache: pnpm
      - name: 🛠️ Install dependencies
        run: pnpm install --frozen-lockfile
      - name: ⌛ Run build
        run: pnpm build
      - name: 🎨 Run lint
        run: pnpm lint
      - name: 🧪 Install package test
        run: |
          TEST_DIR="test-install"
          mkdir "$TEST_DIR"
          pnpm pack --pack-destination "$TEST_DIR"
          cd "$TEST_DIR"
          echo "📦 Creating package.json..."
          echo '{"name":"test-package","version":"1.0.0","private":true}' > package.json
          PACKAGE_TARBALL=$(find . -maxdepth 1 -name '*.tgz' -print -quit)
          echo "📦 Found package: $PACKAGE_TARBALL"
          echo "🔍 Current directory structure:"
          ls -la
          echo "📥 Installing package..."
          pnpm add --save-dev "$PACKAGE_TARBALL"

  test-ci:
    name: 🗂️ ${{ matrix.target.name }}
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: mysql - 8.0
            service: |
              {
                "database": {
                  "image": "mysql:8",
                  "env": {
                    "MYSQL_ROOT_PASSWORD": "test",
                    "MYSQL_DATABASE": "test"
                  },
                  "ports": ["3306:3306"],
                  "options": "--health-cmd=\"mysqladmin ping -h 127.0.0.1 -ptest\" --health-interval=10s --health-timeout=5s --health-retries=10"
                }
              }
            envScript: |
              echo "TEST_DB_TYPE=mysql" >> "$GITHUB_ENV"
              echo "TEST_MYSQL_HOST=127.0.0.1" >> "$GITHUB_ENV"
              echo "TEST_MYSQL_PORT=3306" >> "$GITHUB_ENV"
              echo "TEST_MYSQL_USER=root" >> "$GITHUB_ENV"
              echo "TEST_MYSQL_PASSWORD=test" >> "$GITHUB_ENV"
              echo "TEST_MYSQL_DATABASE=test" >> "$GITHUB_ENV"
              echo "TEST_SEED=$GITHUB_RUN_ID" >> "$GITHUB_ENV"
            setupScript: ""
          - name: mariadb - latest
            service: |
              {
                "database": {
                  "image": "mariadb:latest",
                  "env": {
                    "MARIADB_ROOT_PASSWORD": "test",
                    "MARIADB_DATABASE": "test",
                    "MARIADB_ROOT_HOST": "%"
                  },
                  "ports": ["3307:3306"],
                  "options": "--health-cmd=\"healthcheck.sh --connect --innodb_initialized\" --health-interval=12s --health-timeout=7s --health-retries=3"
                }
              }
            envScript: |
              echo "TEST_DB_TYPE=mariadb" >> "$GITHUB_ENV"
              echo "TEST_MARIADB_HOST=127.0.0.1" >> "$GITHUB_ENV"
              echo "TEST_MARIADB_PORT=3307" >> "$GITHUB_ENV"
              echo "TEST_MARIADB_DATABASE=test" >> "$GITHUB_ENV"
              echo "TEST_MARIADB_ADMIN_USER=root" >> "$GITHUB_ENV"
              echo "TEST_MARIADB_ADMIN_PASSWORD=test" >> "$GITHUB_ENV"
              echo "TEST_SEED=$GITHUB_RUN_ID" >> "$GITHUB_ENV"
            setupScript: ""
          - name: postgres - 16
            service: |
              {
                "database": {
                  "image": "postgres:16",
                  "env": {
                    "POSTGRES_USER": "typeorm-test-db",
                    "POSTGRES_PASSWORD": "test",
                    "POSTGRES_DB": "test"
                  },
                  "ports": ["5432:5432"],
                  "options": "--health-cmd=\"pg_isready -q -d $${POSTGRES_DB} -U $${POSTGRES_USER}\" --health-interval=10s --health-timeout=5s --health-retries=10"
                }
              }
            envScript: |
              echo "TEST_DB_TYPE=postgres" >> "$GITHUB_ENV"
              echo "TEST_POSTGRES_HOST=127.0.0.1" >> "$GITHUB_ENV"
              echo "TEST_POSTGRES_PORT=5432" >> "$GITHUB_ENV"
              echo "TEST_POSTGRES_USER=typeorm-test-db" >> "$GITHUB_ENV"
              echo "TEST_POSTGRES_PASSWORD=test" >> "$GITHUB_ENV"
              echo "TEST_POSTGRES_DATABASE=test" >> "$GITHUB_ENV"
              echo "TEST_SEED=$GITHUB_RUN_ID" >> "$GITHUB_ENV"
            setupScript: ""
          - name: sqlite - in-memory
            service: "{}"
            envScript: |
              echo "TEST_DB_TYPE=sqlite" >> "$GITHUB_ENV"
              echo "TEST_SQLITE_DATABASE=:memory:" >> "$GITHUB_ENV"
              echo "TEST_SEED=$GITHUB_RUN_ID" >> "$GITHUB_ENV"
            setupScript: ""
          - name: better-sqlite3 - file
            service: "{}"
            envScript: |
              echo "TEST_DB_TYPE=better-sqlite3" >> "$GITHUB_ENV"
              echo "TEST_BETTER_SQLITE_DATABASE=.tmp/better-sqlite/test.db" >> "$GITHUB_ENV"
              echo "TEST_SEED=$GITHUB_RUN_ID" >> "$GITHUB_ENV"
            setupScript: |
              mkdir -p .tmp/better-sqlite
    services: ${{ fromJSON(matrix.target.service) }}
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v5
      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "${{ env.PNPM_VERSION }}"
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "${{ env.NODE_VERSION }}"
          cache: pnpm
      - name: 🛠️ Install dependencies
        run: pnpm install --frozen-lockfile
      - name: 🚧 Build package
        run: pnpm build
      - name: 🔧 Configure database environment
        run: ${{ matrix.target.envScript }}
      - name: 🚧 Prepare database instance
        if: matrix.target.setupScript != ''
        run: ${{ matrix.target.setupScript }}
      - name: 🧪 Run tests
        run: pnpm test:ci

  check-all:
    needs:
      - build
      - test-ci
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: ✅ Ensure all jobs succeeded
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Lint job failed"
            exit 1
          fi
          if [ "${{ needs.test-ci.result }}" != "success" ]; then
            echo "Test matrix failed"
            exit 1
          fi
          echo "All checks passed"
